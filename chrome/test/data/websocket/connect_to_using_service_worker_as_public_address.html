<!DOCTYPE html>
<html>
<head>
<title>test ws connection</title>
<script type="text/javascript">

const href = window.location.href;
const queryBegin = href.indexOf('?url=');
if (queryBegin == -1) {
  console.log("Failed to find ?url= in URL");
  document.title = 'FAIL';
  throw "FAILURE";
}
const url = href.slice(queryBegin + 5);

const workerConnection = new Promise(async (resolve, reject) => {
  await navigator.serviceWorker.register('connect_to_using_service_worker_as_public_address.js');
  await navigator.serviceWorker.ready;
  const registration = await navigator.serviceWorker.ready;
  const channel = new MessageChannel();
  channel.port1.onmessage = event => {
    if (event.data === 'PASS') {
      resolve();
    } else if (event.data === 'FAIL') {
      reject();
    }
  };

  registration.active.postMessage({url}, [channel.port2]);
});

workerConnection.then(() => {
  // Set document title to 'PASS'. The test observer catches this title changes
  // to know the result.
  document.title = 'PASS';
}, () => {
  // Set document title to 'FAIL'.
  document.title = 'FAIL';
});

</script>
</head>
</html>
