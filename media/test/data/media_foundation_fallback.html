<!DOCTYPE html>
<html>
<title>Test crashing media foundation cdm removes it from available key systems</title>
<div id="console"></div>
<body onload="runTest();"></body>
<script src='eme_player_js/app_loader.js' type='text/javascript'></script>
<script type='text/javascript'>

  // Special key id that invokes a crash in the Media Foundation Clear Key CDM.
  const crashKeyId = 'crash-crashcrash';

  // The number of times to crash the CDM before we expect it to be disabled.
  const crashAttemptsBeforeFallback = 2;

  // This test only uses |keySystem|.
  var testConfig = new TestConfig();
  testConfig.loadQueryParams();


  const initDataType = 'keyids';
  const initData = Utils.createKeyIdsInitializationData(crashKeyId)

  // Use the default KEY as specified in eme_player_js/globals.js.
  const key = KEY;

  const config = [{
    initDataTypes: [initDataType],
    audioCapabilities: [
      { contentType: 'audio/mp4; codecs="mp4a.40.2"' },
    ],
    videoCapabilities: [{ contentType: MEDIA_TYPES['MP4 - Video Only'] }],
    persistentState: 'optional',
    sessionTypes: ['temporary'],
  }];

  // Creates a MediaKeySession and uses a special key ID to trigger a crash
  // in the underlying CDM.
  async function triggerCdmCrash() {
    let access = await navigator.requestMediaKeySystemAccess(testConfig.keySystem, config);
    let mediaKeys = await access.createMediaKeys();
    let mediaKeySession = mediaKeys.createSession();

    Utils.timeLog('Generating request with crash key ID.');
    await mediaKeySession.generateRequest(initDataType, initData);

    const waitForKeyStatusChangePromise =
      Utils.waitForEvent(mediaKeySession, 'keystatuseschange');
    Utils.timeLog('Calling update() to trigger crash.');
    const jwkSet = Utils.createJWKData(crashKeyId, key);
    return Promise.all([
      mediaKeySession.update(jwkSet),
      waitForKeyStatusChangePromise,
    ]);
  }

  async function runTest() {
    // This test verifies that after a CDM crashes multiple times, it is
    // disabled, and subsequent requests for the same key system will fail.
    try {
      for (let i = 1; i <= crashAttemptsBeforeFallback; i++) {
        Utils.timeLog(`Attempting CDM crash #${i}...`);
        await triggerCdmCrash();
      }
    } catch (error) {
      Utils.failTest(`One of the initial crash attempts failed unexpectedly: ${error}`);
      return;
    }

    // The next attempt should fail because the key system should now be disabled.
    Utils.timeLog('Attempting to create session again (expected to fail)...');
    try {
      await triggerCdmCrash();
      // If we get here, the test has failed because the key system was not disabled.
      Utils.failTest('Key system should not have been supported after multiple crashes.');
    } catch (error) {
      Utils.timeLog(`Successfully failed as expected with error: ${error}`);
      Utils.setResultInTitle('ENDED');
    }
  }
</script>
</html>
